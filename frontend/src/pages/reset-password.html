<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Reset Password - Rhyme Box</title>
  <!-- ✅ ADD FAVICON -->
  <link rel="icon" type="image/svg+xml" href="/frontend/src/assets/favicon.svg">
  <link rel="alternate icon" href="/frontend/src/assets/favicon.ico">
  <link rel="stylesheet" href="/frontend/src/styles/style.css" />
  <link rel="stylesheet" href="/frontend/src/styles/login.css" />
</head>
<body>
  <!-- ✅ Use same container styling as login page -->
  <div class="login-container">
    <div class="login-header">
      <h1>Rhyme Box</h1>
      <p>Reset Your Password</p>
    </div>
    
    <form class="auth-form active" id="resetPasswordForm">
      <p style="color:var(--muted);text-align:center;margin-bottom:20px;">Enter your new password below.</p>
      
      <div class="form-group">
        <label for="newPassword">New Password</label>
        <input type="password" id="newPassword" name="password" placeholder="Enter new password" required minlength="8">
        
        <div class="password-requirements">
          <ul>
            <li id="req-length">✓ At least 8 characters</li>
            <li id="req-upper">✓ One uppercase letter</li>
            <li id="req-number">✓ One number</li>
          </ul>
        </div>
      </div>
      
      <div class="form-group">
        <label for="confirmPassword">Confirm Password</label>
        <input type="password" id="confirmPassword" name="confirmPassword" placeholder="Re-enter password" required minlength="8">
      </div>
      
      <button type="submit" class="submit-btn">Reset Password</button>
      
      <div style="text-align:center;margin-top:20px;">
        <a href="/" style="color:var(--lavender);text-decoration:none;font-weight:500;">← Back to Home</a>
      </div>
    </form>
  </div>
  
  <script>
    // Get token from URL
    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get('token');
    
    if (!token) {
      alert('Invalid reset link. Please request a new password reset.');
      window.location.href = '/';
    }
    
    // Password validation UI
    const passwordInput = document.getElementById('newPassword');
    passwordInput.addEventListener('input', function() {
      const password = this.value;
      const reqLength = document.getElementById('req-length');
      const reqUpper = document.getElementById('req-upper');
      const reqNumber = document.getElementById('req-number');
      
      if (reqLength) reqLength.style.color = password.length >= 8 ? '#4CAF50' : 'var(--muted)';
      if (reqUpper) reqUpper.style.color = /[A-Z]/.test(password) ? '#4CAF50' : 'var(--muted)';
      if (reqNumber) reqNumber.style.color = /[0-9]/.test(password) ? '#4CAF50' : 'var(--muted)';
    });
    
    // Handle form submission
    document.getElementById('resetPasswordForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const password = document.getElementById('newPassword').value;
      const confirmPassword = document.getElementById('confirmPassword').value;
      
      if (password !== confirmPassword) {
        alert('❌ Passwords do not match');
        return;
      }
      
      const submitBtn = e.target.querySelector('button[type="submit"]');
      const originalText = submitBtn.textContent;
      submitBtn.disabled = true;
      submitBtn.textContent = 'Resetting...';
      
      try {
        const response = await fetch('/api/auth/reset-password', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            token: token,
            new_password: password
          })
        });
        
        const result = await response.json();
        
        if (response.ok) {
          alert('✅ Password reset successfully! You can now login with your new password.');
          window.location.href = '/';
        } else {
          throw new Error(result.detail || 'Failed to reset password');
        }
      } catch (error) {
        console.error('Reset error:', error);
        alert('❌ ' + error.message);
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
      }
    });
  </script>
</body>
</html>
